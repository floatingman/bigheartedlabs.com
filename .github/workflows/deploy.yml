name: Build and Deploy

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    name: Build Static Site
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build site
        run: npm run build
        env:
          COMPANY_NAME: "Big Hearted Labs"
          TAGLINE: "Expert Test Automation & CI/CD Solutions"
          CONTACT_EMAIL: "contact@bigheartedlabs.com"
          FOOTER_TEXT: "All rights reserved."

      - name: Export static site
        run: npm run export

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: static-site
          path: out/
          retention-days: 7

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: static-site
          path: out/

      - name: Validate deployment secrets
        run: |
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "‚ùå Error: DEPLOY_HOST secret is not set"
            echo "Please configure the following secrets in your repository:"
            echo "  - DEPLOY_HOST: The hostname or IP of your deployment server"
            echo "  - DEPLOY_USER: The SSH user for deployment"
            echo "  - DEPLOY_PATH: The target path on the server"
            echo "  - SSH_PRIVATE_KEY: The SSH private key for authentication"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "‚ùå Error: DEPLOY_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "‚ùå Error: DEPLOY_PATH secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo mkdir -p ${{ secrets.DEPLOY_PATH }}.backup && \
             sudo rm -rf ${{ secrets.DEPLOY_PATH }}.backup/* && \
             sudo cp -r ${{ secrets.DEPLOY_PATH }}/* ${{ secrets.DEPLOY_PATH }}.backup/ 2>/dev/null || true"

      - name: Create directory on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo mkdir -p ${{ secrets.DEPLOY_PATH }} && \
             sudo chown ${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }} ${{ secrets.DEPLOY_PATH }}"

      - name: Deploy to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --progress \
            ./out/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Set permissions
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo chown -R www-data:www-data ${{ secrets.DEPLOY_PATH }} && \
             sudo find ${{ secrets.DEPLOY_PATH }} -type d -exec chmod 755 {} \; && \
             sudo find ${{ secrets.DEPLOY_PATH }} -type f -exec chmod 644 {} \;"

      - name: Reload Nginx
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo nginx -t && sudo systemctl reload nginx"

      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Website: https://${{ secrets.DEPLOY_HOST }}"
          echo "üì¶ Files deployed to: ${{ secrets.DEPLOY_PATH }}"
